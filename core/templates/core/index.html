{% extends "core/base.html" %}
{% load static %}

{% block header %}
<nav class="navbar fixed-top" style="background-color: #F7F4ED; border-bottom: 1px solid #ddd;">
  <div class="container position-relative">
    <div class="d-flex justify-content-center align-items-center w-100">
      <a class="btn btn-outline-secondary btn-sm text-decoration-none me-2" href="{% url 'core:pre' pre=current_date %}">
        <i class="bi bi-chevron-left fs-4" style="color: #2C2C2C;"></i>
      </a>
      <span class="fw-bold fs-5 mx-2" style="color: #2C2C2C;">{{ current_date|date:'n/j' }}</span>
      <a class="btn btn-outline-secondary btn-sm text-decoration-none ms-2" href="{% url 'core:post' post=current_date %}">
        <i class="bi bi-chevron-right fs-4" style="color: #2C2C2C;"></i>
      </a>
    </div>
    <div class="position-absolute top-0 end-0 d-flex">
      <a class="btn btn-sm text-decoration-none me-2" href="{% url 'core:index' %}">
        <i class="bi bi-arrow-clockwise fs-4" style="color: #2C2C2C;"></i>
      </a>
      <button class="btn text-decoration-none" data-bs-toggle="modal" data-bs-target="#calendarModal">
        <i class="bi bi-calendar3 fs-4" style="color: #2C2C2C;"></i>
      </button>
    </div>
  </div>
</nav>

<div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border: 1px solid #ddd;">
      <div class="modal-header" style="background-color: #F7F4ED;">
        <h1 class="modal-title fs-5" id="calendarModalLabel" style="color: #2C2C2C;">Select Date</h1>
        <button type="button" class="btn-close"></button>
      </div>
      <div class="modal-body">
        <form action="{% url 'core:select_date' %}" method="POST">
          {% csrf_token %}
          <div class="mb-3">
            <label for="dateInput" class="form-label" style="color: #4A4A4A;">日付選択</label>
            <input type="date" class="form-control" name="date">
          </div>
          <input type="submit" class="btn btn-primary">
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <!-- PriorityTask カード -->
    <div class="col-12 col-md-4 my-3">
      <div class="card shadow-sm" style="border: 1px solid #ddd; border-radius: 5px;">
        <img src="{% static 'core/images/task.jpg' %}" class="card-img-top" alt="Priority Task Icon" style="object-fit: cover; height: 200px; border-top-left-radius: 5px; border-top-right-radius: 5px;">
        <div class="card-body">
          <h5 class="card-title" style="font-family: 'Bodoni Moda', serif; color: #2C2C2C;">
            Priority Task
            <span tabindex="0" 
                data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-content="今日の中で特に達成したい3つのタスクを登録します。3つにタスクを絞ることで達成率が上がるという実験結果があります。" 
                style="cursor: pointer; margin-left: 5px;">
            <i class="bi bi-question-circle"></i>
          </span>
          </h5>
          {% if task %}
          <ul class="list-group list-group-flush mb-3">
            {% if task.task1 %}
            <li class="list-group-item bg-transparent" style="font-family: 'Roboto', sans-serif; color: #4A4A4A;">{{ task.task1 }}</li>
            {% endif %}
            {% if task.task2 %}
            <li class="list-group-item bg-transparent" style="font-family: 'Roboto', sans-serif; color: #4A4A4A;">{{ task.task2 }}</li>
            {% endif %}
            {% if task.task3 %}
            <li class="list-group-item bg-transparent" style="font-family: 'Roboto', sans-serif; color: #4A4A4A;">{{ task.task3 }}</li>
            {% endif %}
          </ul>
          <div class="text-end">
            <a href="{% url 'PriorityTask:edit' pk=task.id %}" class="btn btn-outline-secondary btn-sm me-2" style="color: #5d4037; border-color: #5d4037;">編集</a>
            <form action="{% url 'PriorityTask:delete' pk=task.id %}" method="POST" class="d-inline" onsubmit="return confirm('本当に削除しますか？')">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary btn-sm" style="color: #5d4037; border-color: #5d4037;">削除</button>
            </form>
          </div>
          {% elif current_date > today %}
          <p class="h5 mb-0 text-center" style="color: #8C8C8C;">まだ先のお話、、、</p>
          {% else %}
          <div class="text-center">
            <a href="{% url 'PriorityTask:add' %}" class="btn btn-outline-primary" style="border-color: #5d4037; color: #5d4037;">タスクを追加</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Habit カード -->
    <div class="col-12 col-md-4 my-3">
      <div class="card shadow-sm" style="border: 1px solid #ddd; border-radius: 5px;">
        <img src="{% static 'core/images/book.jpg' %}" class="card-img-top" alt="Habit Icon" style="object-fit: cover; height: 200px; border-top-left-radius: 5px; border-top-right-radius: 5px;">
        <div class="card-body">
          <h5 class="card-title" style="font-family: 'Bodoni Moda', serif; color: #2C2C2C;">
            Habit
            <span tabindex="0" 
                data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-content="13週間(約三か月)で習慣化完了とします。習慣化率は達成できた週が何個あるかを計算し、表示します。" 
                style="cursor: pointer; margin-left: 5px;">
            <i class="bi bi-question-circle"></i>
          </span>
          </h5>
          <div class="mb-3">
            {% if habit_data %}
              <ul class="list-group list-group-flush">
                {% for habitdata in habit_data %}
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent" style="border: none;">
                  <div>
                    <h6 class="mb-1" style="font-family: 'Roboto', sans-serif; color: #4A4A4A;">{{ habitdata.habit.name }}</h6>
                    <small style="color: #8C8C8C;">今週の達成率：{{ habitdata.weekly_rate }}%</small><br>
                    <small style="color: #8C8C8C;">習慣化率：{{ habitdata.success_weeks }}/13 ({{ habitdata.success_percentage }}%)</small>
                  </div>
                  <div class="btn-group" role="group">
                    <!-- 今日達成できていれば（completed=True）→明るいグリーン -->
                    {% if habitdata.current_log.completed == True %}
                    <a href="{% url 'Habit:HabitLogStatusChange' pk=habitdata.current_log.id %}" 
                      class="btn btn-outline-success btn-sm" 
                      title="今日達成済み" 
                      style="color: #66BB6A; border-color: #66BB6A;">
                      <i class="bi bi-check-circle"></i>
                    </a>
                    <!-- 今日達成できてなかったら（completed=False）→落ち着いたグレー -->
                    {% elif habitdata.current_log.completed == False %}
                    <a href="{% url 'Habit:HabitLogStatusChange' pk=habitdata.current_log.id %}" 
                      class="btn btn-outline-success btn-sm" 
                      title="今日未達成" 
                      style="color: #B0BEC5; border-color: #B0BEC5;">
                      <i class="bi bi-check-circle"></i>
                    </a>
                    <!---そもそもログが発行されてないとき-->
                    {% elif habitdata.current_log == None %}
                      <a href="{% url 'Habit:HabitLogAdd' habit_pk=habitdata.habit.id %}" class="btn btn-outline-success btn-sm" title="チェックを付けよう" style="color: #5d4037; border-color: #5d4037;">
                        <i class="bi bi-check-circle"></i>
                      </a>
                    {% endif %}

                    <a href="{% url 'Habit:HabitEdit' pk=habitdata.habit.id%}" class="btn btn-outline-primary btn-sm" style="color: #5d4037; border-color: #5d4037;">
                      <i class="bi bi-pencil-square"></i>
                    </a>
                    <form action="{% url 'Habit:HabitDelete' pk=habitdata.habit.id %}" method="POST" onsubmit="return confirm('本当に削除しますか？')">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger btn-sm" style="color: #5d4037; border-color: #5d4037;">
                      <i class="bi bi-trash3"></i>
                      </button>
                    </form>
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="h5 text-center" style="color: #8C8C8C;">習慣が登録されていません。</p>
            {% endif %}
          </div>
          <div class="text-center">
            <a href="{% url 'Habit:HabitAdd' %}" class="btn btn-outline-secondary" style="color: #5d4037; border-color: #5d4037;">新しい習慣を登録</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Tweet カード -->
    <div class="col-12 col-md-4 my-3">
      <div class="card shadow-sm" style="border: 1px solid #ddd; border-radius: 5px;">
        <img src="{% static 'core/images/bird-2119874_640.jpg' %}" class="card-img-top" alt="Tweet Icon" style="object-fit: cover; height: 200px; border-top-left-radius: 5px; border-top-right-radius: 5px;">
        <div class="card-body">
          <h5 class="card-title" style="font-family: 'Bodoni Moda', serif; color: #2C2C2C;">
            Tweet
            <span tabindex="0" 
                data-bs-toggle="popover" 
                data-bs-trigger="hover focus" 
                data-bs-content="考えたことのメモとして、日記として、思うままにご活用ください。" 
                style="cursor: pointer; margin-left: 5px;">
            <i class="bi bi-question-circle"></i>
          </span>
          </h5>
          {% if tweets %}
            {% for tweet in tweets %}
            <div class="mb-3">
              <!-- 全体をフレックスコンテナにして、本文と削除ボタンを横並びに配置 -->
              <div class="p-3 d-flex justify-content-between align-items-center"
                  style="background-color: #F7F4ED; border: 1px solid #ddd; border-radius: 15px; font-family: 'Roboto', sans-serif; color: #4A4A4A;">
                <!-- 本文部分 -->
                <div class="flex-grow-1 me-3">
                  {{ tweet.content }}
                </div>
                <!-- 削除ボタン部分 -->
                <form action="{% url 'Tweet:delete' pk=tweet.id %}" method="POST" class="m-0">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="削除" style="color: #5d4037; border-color: #5d4037;">
                    <i class="bi bi-trash3"></i>
                  </button>
                </form>
              </div>
            </div>
            {% endfor %}
          {% else %}
          {% endif %}
          <div class="text-center">
            <a href="{% url 'Tweet:add' %}" class="btn btn-outline-success" style="color: #5d4037; border-color: #5d4037;">つぶやく</a>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block footer %}
<nav class="navbar fixed-bottom" style="background-color: #F7F4ED; border-top: 1px solid #ddd;">
  <div class="container d-flex justify-content-around">
    <a href="{% url 'core:index' %}" class="nav-button" style="color: #2C2C2C;">
      <i class="bi bi-house-door fs-5"></i><br><small>Today</small>
    </a>
    <a href="#" class="nav-button" style="color: #2C2C2C;" onclick="alert('Trends画面は未実装'); return false;">
      <i class="bi bi-graph-up fs-5"></i><br><small>Trends</small>
    </a>
    <a href="#" class="nav-button" style="color: #2C2C2C;" onclick="alert('Community画面は未実装'); return false;">
      <i class="bi bi-people fs-5"></i><br><small>Community</small>
    </a>
    <a href="#" class="nav-button" style="color: #2C2C2C;" onclick="alert('Profile画面は未実装'); return false;">
      <i class="bi bi-person fs-5"></i><br><small>Profile</small>
    </a>
  </div>
</nav>
{% endblock %}
